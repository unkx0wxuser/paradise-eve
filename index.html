<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paradise Eve</title>
    <link rel="stylesheet" href="style.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const getUsers = () => {
            const usersJson = localStorage.getItem('bandTest01_users');
            return usersJson ? JSON.parse(usersJson) : {};
        };

        const saveUsers = (users) => {
            localStorage.setItem('bandTest01_users', JSON.stringify(users));
        };

        const getUser = (email) => {
            const users = getUsers();
            return users[email] || null;
        };

        const saveUser = (userData) => {
            const users = getUsers();
            users[userData.email] = userData;
            saveUsers(users);
            return userData;
        };

        const updateUserChips = (email, chips) => {
            const users = getUsers();
            if (users[email]) {
                users[email].tokens = chips;
                saveUsers(users);
                return users[email];
            }
            return null;
        };

        const login = (email, password) => {
            const user = getUser(email);
            if (user && user.password === password) {
                return user;
            }
            return null;
        };

        const getCurrentUserEmail = () => {
            return localStorage.getItem('bandTest01_currentUser');
        };

        const setCurrentUser = (email) => {
            if (email) {
                localStorage.setItem('bandTest01_currentUser', email);
            } else {
                localStorage.removeItem('bandTest01_currentUser');
            }
        };

        function SignupForm({ onSuccess }) {
            const [formData, setFormData] = useState({
                name: '',
                email: '',
                password: '',
                confirmPassword: ''
            });

            const [errors, setErrors] = useState({});
            const [success, setSuccess] = useState('');

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
                if (errors[name]) {
                    setErrors(prev => ({
                        ...prev,
                        [name]: ''
                    }));
                }
                setSuccess('');
            };

            const validateForm = () => {
                const newErrors = {};
                const users = getUsers();

                if (!formData.name.trim()) {
                    newErrors.name = '이름 입력';
                }

                if (!formData.email.trim()) {
                    newErrors.email = '이메일 입력';
                } else if (!/\S+@\S+\.\S+/.test(formData.email)) {
                    newErrors.email = '올바른 이메일 형식이 아닙니다';
                } else if (users[formData.email]) {
                    newErrors.email = '이미 가입된 이메일입니다';
                }

                if (!formData.password) {
                    newErrors.password = '패스워드 입력(6자 이상)';
                } else if (formData.password.length < 6) {
                    newErrors.password = '올바른 패스워드 형식이 아닙니다';
                }

                if (formData.password !== formData.confirmPassword) {
                    newErrors.confirmPassword = '패스워드가 일치하지 않습니다';
                }

                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (validateForm()) {
                    try {
                        saveUser({
                            name: formData.name,
                            email: formData.email,
                            password: formData.password,
                            tokens: 10
                        });
                        setSuccess('가입 완료 - 자동 로그인 중');
                        
                        setTimeout(() => {
                            setCurrentUser(formData.email);
                            onSuccess();
                        }, 1000);
                    } catch (error) {
                        setErrors({ submit: '회원가입 실패 - 관리자에게 문의' });
                    }
                }
            };

            return (
                <form onSubmit={handleSubmit}>
                    <div className="form-group">
                        <label className="form-label" htmlFor="signup-name">이름</label>
                        <input
                            type="text"
                            id="signup-name"
                            name="name"
                            className="form-input"
                            placeholder="이름 입력"
                            value={formData.name}
                            onChange={handleChange}
                        />
                        {errors.name && <div className="error-message">{errors.name}</div>}
                    </div>

                    <div className="form-group">
                        <label className="form-label" htmlFor="signup-email">이메일</label>
                        <input
                            type="email"
                            id="signup-email"
                            name="email"
                            className="form-input"
                            placeholder="이메일 입력"
                            value={formData.email}
                            onChange={handleChange}
                        />
                        {errors.email && <div className="error-message">{errors.email}</div>}
                    </div>

                    <div className="form-group">
                        <label className="form-label" htmlFor="signup-password">패스워드</label>
                        <input
                            type="password"
                            id="signup-password"
                            name="password"
                            className="form-input"
                            placeholder="패스워드 입력"
                            value={formData.password}
                            onChange={handleChange}
                        />
                        {errors.password && <div className="error-message">{errors.password}</div>}
                    </div>

                    <div className="form-group">
                        <label className="form-label" htmlFor="signup-confirmPassword">패스워드 확인</label>
                        <input
                            type="password"
                            id="signup-confirmPassword"
                            name="confirmPassword"
                            className="form-input"
                            placeholder="패스워드를 다시 입력하세요"
                            value={formData.confirmPassword}
                            onChange={handleChange}
                        />
                        {errors.confirmPassword && <div className="error-message">{errors.confirmPassword}</div>}
                    </div>

                    {success && <div className="success-message">{success}</div>}
                    {errors.submit && <div className="error-message">{errors.submit}</div>}

                    <button type="submit" className="submit-button">
                        가입
                    </button>
                </form>
            );
        }

        function LoginForm({ onSuccess }) {
            const [formData, setFormData] = useState({
                email: '',
                password: ''
            });

            const [error, setError] = useState('');

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
                setError('');
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const user = login(formData.email, formData.password);

                if (!user) {
                    setError('이메일 또는 패스워드가 일치하지 않습니다');
                    return;
                }

                setCurrentUser(formData.email);
                onSuccess();
            };

            return (
                <form onSubmit={handleSubmit}>
                    <div className="form-group">
                        <label className="form-label" htmlFor="login-email">이메일</label>
                        <input
                            type="email"
                            id="login-email"
                            name="email"
                            className="form-input"
                            placeholder="이메일 입력"
                            value={formData.email}
                            onChange={handleChange}
                        />
                    </div>

                    <div className="form-group">
                        <label className="form-label" htmlFor="login-password">패스워드</label>
                        <input
                            type="password"
                            id="login-password"
                            name="password"
                            className="form-input"
                            placeholder="패스워드 입력"
                            value={formData.password}
                            onChange={handleChange}
                        />
                    </div>

                    {error && <div className="error-message">{error}</div>}

                    <button type="submit" className="submit-button">
                        로그인
                    </button>
                </form>
            );
        }

        function Scoreboard({ currentUserEmail, onRefresh }) {
            const [scoreboard, setScoreboard] = useState([]);

            useEffect(() => {
                const updateScoreboard = () => {
                    const sortedUsers = getScoreboard();
                    setScoreboard(sortedUsers);
                };

                updateScoreboard();
                const interval = setInterval(updateScoreboard, 1000);
                return () => clearInterval(interval);
            }, [onRefresh]);
        }

        function ShopItem({ itemNumber, itemPrice, user, onPurchase }) {
            const [itemName, setItemName] = useState('');
            const defaultNames = {
                1: '+2 OR -3',
                2: '+5 OR -7',
                3: 'RANDOM DICE',
                4: 'ALL OR NOTHING',
            };

            useEffect(() => {
                const names = JSON.parse(localStorage.getItem('bandTest01_itemNames') || '{}');
                setItemName(names[itemNumber] || defaultNames[itemNumber]);
            }, []);

            const handleItemClick = () => {
                if (itemNumber === 4) {
                    if (user.tokens >= 1) {
                        onPurchase(itemNumber);
                    }
                } else {
                    if (user.tokens >= itemPrice) {
                        onPurchase(itemNumber);
                    }
                }
            };

            const getPriceDisplay = () => {
                if (itemNumber === 4) {
                    return 'ALL IN';
                }
                return `${itemPrice}`;
            };

            const isDisabled = () => {
                if (itemNumber === 4) {
                    return user.tokens < 1;
                }
                return user.tokens < itemPrice;
            };

            return (
                <div
                    className={`shop-item ${isDisabled() ? 'disabled' : ''}`}
                    onClick={handleItemClick}
                >
                    <div className="item-name">{itemName}</div>
                    <div className="item-price">
                        {itemNumber !== 4 && (
                            <img src="chip.png" alt="칩" className="chip-icon" />
                        )}
                        <span>{getPriceDisplay()}</span>
                    </div>
                </div>
            );
        }

        function Shop({ user, onPurchase, onBack }) {
            const [purchaseMessage, setPurchaseMessage] = useState('');

            const getItemPrice = (itemNumber) => {
                if (itemNumber === 1) return 2;
                if (itemNumber === 2) return 5;
                if (itemNumber === 3) return 10;
                if (itemNumber === 4) return user.tokens;
                return 2;
            };

            const handlePurchase = (itemNumber) => {
                try {
                    const price = getItemPrice(itemNumber);
                    
                    if (user.tokens < price) {
                        setPurchaseMessage('칩 부족');
                        setTimeout(() => setPurchaseMessage(''), 2000);
                        return;
                    }

                    if (itemNumber === 1) {
                        const newChipCount = user.tokens - price;
                        const isSuccess = Math.random() < 0.5;
                        const finalChipCount = isSuccess 
                            ? newChipCount + 2 
                            : Math.max(0, newChipCount - 3);
                        
                        updateUserChips(user.email, finalChipCount);
                        setPurchaseMessage(isSuccess ? '2 개 획득' : '3 개 소실');
                        setTimeout(() => {
                            setPurchaseMessage('');
                            onPurchase();
                        }, 2000);
                    } else if (itemNumber === 2) {
                        const newChipCount = user.tokens - price;
                        const isSuccess = Math.random() < 0.5;
                        const finalChipCount = isSuccess 
                            ? newChipCount + 5 
                            : Math.max(0, newChipCount - 7);
                        
                        updateUserChips(user.email, finalChipCount);
                        setPurchaseMessage(isSuccess ? '5 개 획득' : '7 개 소실');
                        setTimeout(() => {
                            setPurchaseMessage('');
                            onPurchase();
                        }, 2000);
                    } else if (itemNumber === 3) {
                        const newChipCount = user.tokens - price;
                        const isSuccess = Math.random() < 0.5;
                        const randomAmount = Math.floor(Math.random() * 21) + 10;
                        const finalChipCount = isSuccess 
                            ? newChipCount + randomAmount 
                            : Math.max(0, newChipCount - randomAmount);
                        
                        updateUserChips(user.email, finalChipCount);
                        setPurchaseMessage(isSuccess ? `${randomAmount} 개 획득` : `${randomAmount} 개 소실`);
                        setTimeout(() => {
                            setPurchaseMessage('');
                            onPurchase();
                        }, 2000);
                    } else if (itemNumber === 4) {
                        if (user.tokens < 1) {
                            setPurchaseMessage('칩 부족');
                            setTimeout(() => setPurchaseMessage(''), 2000);
                            return;
                        }

                        const currentChips = user.tokens;
                        const isSuccess = Math.random() < 0.5;
                        
                        if (isSuccess) {
                            const newChipCount = currentChips * 2;
                            updateUserChips(user.email, newChipCount);
                            setPurchaseMessage(`JACKPOT! ${newChipCount} 개 획득`);
                        } else {
                            updateUserChips(user.email, 0);
                            setPurchaseMessage('전부 잃었습니다 . . .');
                        }
                        
                        setTimeout(() => {
                            setPurchaseMessage('');
                            onPurchase();
                        }, 2000);
                    }
                } catch (error) {
                    setPurchaseMessage('오류가 발생했습니다');
                    setTimeout(() => setPurchaseMessage(''), 2000);
                }
            };

            return (
                <div className="shop-section">
                    <div className="shop-grid">
                        {[1, 2, 3, 4].map((itemNumber) => {
                            const itemPrice = getItemPrice(itemNumber);
                            return (
                                <ShopItem
                                    key={itemNumber}
                                    itemNumber={itemNumber}
                                    itemPrice={itemPrice}
                                    user={user}
                                    onPurchase={handlePurchase}
                                />
                            );
                        })}
                    </div>
                    {purchaseMessage && (
                        <div className={`purchase-message ${purchaseMessage.includes('부족') || purchaseMessage.includes('잃었') || purchaseMessage.includes('차감') || purchaseMessage.includes('줄었') ? 'error-message' : 'success-message'}`}>
                            {purchaseMessage}
                        </div>
                    )}
                </div>
            );
        }

        function Roulette({ user, onBack, onSpin }) {
            const [cards, setCards] = useState(['', '', '']);
            const [isSpinning, setIsSpinning] = useState(false);
            const [result, setResult] = useState('');
            const emojis = ['♚', '♛', '♜', '♝', '♞', '♟'];

            const handleSpin = () => {
                if (user.tokens < 5) {
                    setResult('칩 부족');
                    setTimeout(() => setResult(''), 2000);
                    return;
                }

                setIsSpinning(true);
                setResult('');

                try {
                    const newChipCount = user.tokens - 5;
                    updateUserChips(user.email, newChipCount);
                    onSpin();

                    setTimeout(() => {
                        const newCards = cards.map(() => {
                            const randomIndex = Math.floor(Math.random() * emojis.length);
                            return emojis[randomIndex];
                        });
                        setCards(newCards);
                        setIsSpinning(false);

                        if (newCards[0] === newCards[1] && newCards[1] === newCards[2]) {
                            setResult('JACKPOT');
                        } else {
                            setResult('아이고, 오늘 식사는 그르친 것 같네요…');
                        }
                    }, 1000);
                } catch (error) {
                    setIsSpinning(false);
                    setResult('오류 발생');
                }
            };

            return (
                <div className="roulette-section">
                    <div className="roulette-cards">
                        {cards.map((emoji, index) => (
                            <div key={index} className={`roulette-card ${isSpinning ? 'spinning' : ''}`}>
                                {emoji || '?'}
                            </div>
                        ))}
                    </div>
                    {result && (
                        <div className={`roulette-result ${result === '잭팟!!' ? 'jackpot' : 'fail'}`}>
                            {result}
                        </div>
                    )}
                    <button 
                        className="roulette-spin-button" 
                        onClick={handleSpin}
                        disabled={isSpinning || user.tokens < 5}
                    >
                        {isSpinning ? '돌리는 중 . . .' : '룰렛 돌리기 (칩 5 개)'}
                    </button>
                </div>
            );
        }

        function MainView({ user, onLogout, onNavigateToShop, onNavigateToRoulette, refreshTrigger, onChipUpdate }) {
            const [chipInput, setChipInput] = useState('');
            const [message, setMessage] = useState('');

            const handleSetChips = () => {
                const chipsToSet = parseInt(chipInput);
                
                if (isNaN(chipsToSet) || chipsToSet < 0) {
                    setMessage('올바른 숫자를 입력하세요');
                    setTimeout(() => setMessage(''), 2000);
                    return;
                }

                updateUserChips(user.email, chipsToSet);
                setMessage(`설정 완료: ${chipsToSet} 개`);
                setChipInput('');
                
                setTimeout(() => {
                    setMessage('');
                    if (onChipUpdate) {
                        onChipUpdate();
                    }
                }, 1500);
            };

            return (
                <div className="view-container">
                    <div className="title-image-container">
                        <img src="777.png" className="title-image" />
                    </div>
                    <div className="user-info">
                        <h4>접속 아이디: {user.name}</h4>
                        <div className="chip-display">
                            <span className="chip-label">
                                <img src="chip.png" alt="칩" className="chip-label-icon" />
                            </span>
                            <span className="chip-count">{user.tokens} 개</span>
                        </div>
                        <div className="nav-buttons">
                            <button className="nav-button active">조정</button>
                            <button className="nav-button" onClick={onNavigateToShop}>카드</button>
                            <button className="nav-button" onClick={onNavigateToRoulette}>룰렛</button>
                        </div>
                    </div>
                    <div className="chip-add-section">
                        <div className="chip-add-controls">
                            <input
                                type="number"
                                min="0"
                                value={chipInput}
                                onChange={(e) => setChipInput(e.target.value)}
                                placeholder="설정할 칩 개수"
                                className="form-input chip-add-input"
                                onKeyPress={(e) => {
                                    if (e.key === 'Enter') {
                                        handleSetChips();
                                    }
                                }}
                            />
                            <button 
                                className="submit-button chip-add-button"
                                onClick={handleSetChips}
                            >
                                설정
                            </button>
                        </div>
                        {message && (
                            <div className={message.includes('올바른') ? 'error-message' : 'success-message'}>
                                {message}
                            </div>
                        )}
                    </div>
                    <Scoreboard currentUserEmail={user.email} onRefresh={refreshTrigger} />
                    <button className="logout-button" onClick={onLogout}>
                        로그아웃
                    </button>
                </div>
            );
        }

        function ShopView({ user, onBack, onPurchase, onNavigateToRoulette, refreshTrigger }) {
            return (
                <div className="view-container">
                    <div className="title-image-container">
                        <img src="777.png" className="title-image" />
                    </div>
                    <div className="user-info">
                        <h4>접속 아이디: {user.name}</h4>
                        <div className="chip-display">
                            <span className="chip-label">
                                <img src="chip.png" alt="칩" className="chip-label-icon" />
                            </span>
                            <span className="chip-count">{user.tokens} 개</span>
                        </div>
                        <div className="nav-buttons">
                            <button className="nav-button" onClick={onBack}>조정</button>
                            <button className="nav-button active">카드</button>
                            <button className="nav-button" onClick={onNavigateToRoulette}>룰렛</button>
                        </div>
                    </div>
                    <Shop user={user} onPurchase={onPurchase} onBack={onBack} />
                </div>
            );
        }

        function RouletteView({ user, onBack, onPurchase, onNavigateToShop, refreshTrigger }) {
            return (
                <div className="view-container">
                    <div className="title-image-container">
                        <img src="777.png" className="title-image" />
                    </div>
                    <div className="user-info">
                        <h4>접속 아이디: {user.name}</h4>
                        <div className="chip-display">
                            <span className="chip-label">
                                <img src="chip.png" alt="칩" className="chip-label-icon" />
                            </span>
                            <span className="chip-count">{user.tokens} 개</span>
                        </div>
                        <div className="nav-buttons">
                            <button className="nav-button" onClick={onBack}>조정</button>
                            <button className="nav-button" onClick={onNavigateToShop}>카드</button>
                            <button className="nav-button active">룰렛</button>
                        </div>
                    </div>
                    <Roulette user={user} onBack={onBack} onSpin={onPurchase} />
                </div>
            );
        }

        function UserDashboard({ onLogout }) {
            const [user, setUser] = useState(null);
            const [currentView, setCurrentView] = useState('main');
            const [refreshTrigger, setRefreshTrigger] = useState(0);

            useEffect(() => {
                const loadUser = () => {
                    const email = getCurrentUserEmail();
                    if (email) {
                        const userData = getUser(email);
                        if (userData) {
                            setUser(userData);
                        }
                    }
                };
                loadUser();
            }, []);

            useEffect(() => {
                const interval = setInterval(() => {
                    const email = getCurrentUserEmail();
                    if (email) {
                        const userData = getUser(email);
                        if (userData) {
                            setUser(userData);
                            setRefreshTrigger(prev => prev + 1);
                        }
                    }
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            const handleLogout = () => {
                setCurrentUser(null);
                onLogout();
            };

            const handlePurchase = () => {
                const email = getCurrentUserEmail();
                if (email) {
                    const userData = getUser(email);
                    if (userData) {
                        setUser(userData);
                        setRefreshTrigger(prev => prev + 1);
                    }
                }
            };

            if (!user) {
                return <div>사용자 정보를 불러올 수 없습니다</div>;
            }

            if (currentView === 'shop') {
                return (
                    <ShopView
                        user={user}
                        onBack={() => setCurrentView('main')}
                        onPurchase={handlePurchase}
                        onNavigateToRoulette={() => setCurrentView('roulette')}
                        refreshTrigger={refreshTrigger}
                    />
                );
            }

            if (currentView === 'roulette') {
                return (
                    <RouletteView
                        user={user}
                        onBack={() => setCurrentView('main')}
                        onPurchase={handlePurchase}
                        onNavigateToShop={() => setCurrentView('shop')}
                        refreshTrigger={refreshTrigger}
                    />
                );
            }

            return (
                <MainView
                    user={user}
                    onLogout={handleLogout}
                    onNavigateToShop={() => setCurrentView('shop')}
                    onNavigateToRoulette={() => setCurrentView('roulette')}
                    refreshTrigger={refreshTrigger}
                    onChipUpdate={handlePurchase}
                />
            );
        }

        function App() {
            const [mode, setMode] = useState('signup');
            const [isLoggedIn, setIsLoggedIn] = useState(false);

            useEffect(() => {
                const checkLogin = () => {
                    const email = getCurrentUserEmail();
                    if (email) {
                        const user = getUser(email);
                        if (user) {
                            setIsLoggedIn(true);
                        }
                    }
                };
                checkLogin();
            }, []);

            const handleLoginSuccess = () => {
                setIsLoggedIn(true);
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                setMode('login');
            };

            if (isLoggedIn) {
                return <UserDashboard onLogout={handleLogout} />;
            }

            return (
                <div className="view-container">
                    <h1 className="title">{mode === 'signup' ? '회원가입' : '로그인'}</h1>
                    <div className="mode-toggle">
                        <button
                            className={`mode-button ${mode === 'signup' ? 'active' : ''}`}
                            onClick={() => setMode('signup')}
                        >
                            회원가입
                        </button>
                        <button
                            className={`mode-button ${mode === 'login' ? 'active' : ''}`}
                            onClick={() => setMode('login')}
                        >
                            로그인
                        </button>
                    </div>
                    {mode === 'signup' ? (
                        <SignupForm onSuccess={handleLoginSuccess} />
                    ) : (
                        <LoginForm onSuccess={handleLoginSuccess} />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>